name: 'Rust Cache'
description: 'Cache rust dep and build artifacts'
runs:
  using: "composite"
  steps:
  - uses: actions/cache@v3
    with:
      path: |
        ~/.cargo/registry/index/
        ~/.cargo/registry/cache/
        ~/.cargo/git/db/
      key: |
        cargo-deps-${{ hashFiles('**/Cargo.lock') }}
      restore-keys: |
        cargo-deps-
  - uses: actions/cache@v3
    with:
      path: ~/.cargo/target/
      key: |
        cargo-target-global-${{ github.workflow }}-${{ github.job }}-${{ strategy.job-index }}-${{ github.sha }}
      restore-keys: |
        cargo-target-global-${{ github.workflow }}-${{ github.job }}-${{ strategy.job-index }}-
        cargo-target-global-${{ github.workflow }}-${{ github.job }}-
  - shell: bash
    env:
      SCCACHE_VERSION: v0.3.0
      SCCACHE_TAR_GZ_SHA256: e6cd8485f93d683a49c83796b9986f090901765aa4feb40d191b03ea770311d8
    run: >
      curl -sSL -O --output-dir /tmp https://github.com/mozilla/sccache/releases/download/$SCCACHE_VERSION/sccache-$SCCACHE_VERSION-x86_64-unknown-linux-musl.tar.gz
      sha256sum -c <(echo "$SCCACHE_TAR_GZ_SHA256  /tmp/sccache-$SCCACHE_VERSION-x86_64-unknown-linux-musl.tar.gz")
      tar xz -f /tmp/sccache-$SCCACHE_VERSION-x86_64-unknown-linux-musl.tar.gz -C /usr/local/bin --strip-components=1 sccache-$SCCACHE_VERSION-x86_64-unknown-linux-musl/sccache
      chmod +x /usr/local/bin/sccache
  - shell: bash
    run: |
      echo 'RUSTC_WRAPPER=sccache' >> $GITHUB_ENV
      echo 'SCCACHE_CACHE_SIZE=9G' >> $GITHUB_ENV
  - uses: actions/cache@v3
    with:
      path: ~/.cache/sccache
      key: |
        cargo-sccache-${{ github.workflow }}-${{ github.job }}-${{ strategy.job-index }}-${{ github.sha }}
      restore-keys: |
        cargo-sccache-${{ github.workflow }}-${{ github.job }}-${{ strategy.job-index }}-
        cargo-sccache-${{ github.workflow }}-${{ github.job }}-
  - if: github.ref_protected
    shell: bash
    run: rm -fr ~/.cache/sccache
